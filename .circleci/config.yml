# Java Gradle CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2
jobs:
    build:
        docker:
            # specify the version you desire here
            - image: circleci/openjdk:8-jdk

            # Specify service dependencies here if necessary
            # CircleCI maintains a library of pre-built images
            # documented at https://circleci.com/docs/2.0/circleci-images/
            # - image: circleci/postgres:9.4

        working_directory: ~/repo

        environment:
            # Customize the JVM maximum heap limit
            JVM_OPTS: -Xmx3200m
            TERM: dumb

        steps:
            - checkout

            - run:
                name: "Set CI to false"
                command: |
                    echo 'export CI=false' >> $BASH_ENV
                    source $BASH_ENV

            - run:
                name: "Install Node.js and npm"
                command: |
                    curl -sSL "https://nodejs.org/dist/v11.10.0/node-v11.10.0-linux-x64.tar.xz" | sudo tar --strip-components=2 -xJ -C /usr/local/bin/ node-v11.10.0-linux-x64/bin/node
                    curl https://www.npmjs.com/install.sh | sudo bash

            - run:
                name: "Install Dependencies"
                command: |
                    npm install
                    sudo npm install -g pnpm@4.0

            - run:
                name: "Install FE Dependencies"
                command: |
                    cd api-catalog-ui/frontend && pnpm install

          # Download and cache dependencies
            - restore_cache:
                keys:
                    - v1-dependencies-{{ checksum "build.gradle" }}
                    # fallback to using the latest cache if no exact match is found
                    - v1-dependencies-

            - run: gradle dependencies

            - save_cache:
                paths:
                    - ~/.gradle
                key: v1-dependencies-{{ checksum "build.gradle" }}

            # run tests!
            - run: gradle -Denvironment.older=true test
