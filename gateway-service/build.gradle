buildscript {
    repositories mavenRepositories
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
        classpath("gradle.plugin.com.gorylenko.gradle-git-properties:gradle-git-properties:${gradleGitPropertiesVersion}")
    }
}

normalization {
    runtimeClasspath {
        ignore("**/*git.properties*")
        ignore("**/*build-info.properties*")
    }
}

apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'
apply plugin: 'com.gorylenko.gradle-git-properties'
apply from: "$projectDir/gradle/lite.gradle"

springBoot {
    // This statement tells the Gradle Spring Boot plugin to generate a file
    // build/resources/main/META-INF/build-info.properties that is picked up by Spring Boot to display
    // via /info endpoint
    buildInfo {
        properties {
            // Generate extra build info:
            additionalProperties = [
                by             : System.properties['user.name'],
                operatingSystem: "${System.properties['os.name']} (${System.properties['os.version']})",
                number         : System.getenv('BUILD_NUMBER') ? System.getenv('BUILD_NUMBER') : "n/a",
                machine        : InetAddress.localHost.hostName
            ]
        }
    }
}

gitProperties {
    gitPropertiesDir = new File("${project.rootDir}/${name}/build/resources/main/META-INF")
}

configurations.all {
    resolutionStrategy {
        force (libraries.jetty_websocket_client)
    }
}

dependencies {
    implementation(project(':apiml-security-common'))
    implementation libraries.spring_cloud_starter_zuul
    implementation libraries.spring_boot_starter_actuator
    implementation libraries.spring_boot_starter_web
    implementation libraries.spring_boot_starter_websocket
    implementation libraries.spring_boot_starter_thymeleaf
    implementation libraries.spring_boot_starter_cache
    implementation libraries.spring_boot_starter_aop
    implementation libraries.spring_security_web
    implementation libraries.spring_security_config
    implementation libraries.swagger3_core
    implementation libraries.swagger3_parser
    implementation libraries.jackson_core
    implementation libraries.tomcat_coyote
    implementation libraries.tomcat_embed_core
    implementation libraries.spring_cloud_starter_eureka
    implementation libraries.spring_cloud_starter_ribbon
    implementation libraries.jetty_websocket_client
    implementation libraries.jetty_util
    implementation libraries.jjwt
    implementation libraries.nimbusJoseJwt
    implementation libraries.eh_cache
    implementation libraries.spring_retry
    compileOnly libraries.javax_inject
    compileOnly libraries.lombok
    annotationProcessor libraries.lombok

    implementation libraries.springFox
    testCompile libraries.spring_mock_mvc
    testCompile libraries.spring_boot_starter_test
    testRuntime libraries.http_client
    testCompile libraries.rest_assured
    testCompile libraries.javax_inject

    testCompile libraries.lombok
    testAnnotationProcessor libraries.lombok

    testCompile libraries.powermock_api_mockito2
    testCompile libraries.power_mock_junit4
    testCompile libraries.power_mock_junit4_rule


    runtime libraries.jjwt_impl
    runtime libraries.jjwt_jackson
}

bootJar {
    archiveFileName = "gateway-service.jar"
    manifest {
        attributes 'Main-Class': 'org.springframework.boot.loader.PropertiesLauncher'
    }
}

bootRun {
    if (project.hasProperty('args')) {
        args project.args.split(',')
    }
    systemProperties = System.properties
}

jar {
    enabled = true
    archiveName = "${jar.baseName}-thin.jar"

    def libClassPathEntries = configurations.runtime.files.collect {
        "lib/" + it.getName()
    }
    doFirst {
        manifest {
            attributes "Class-Path": libClassPathEntries.join(" "),
                "Main-Class": "org.zowe.apiml.gateway.GatewayApplication"
        }
    }
}
